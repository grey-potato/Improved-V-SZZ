# LLM ä¸»å¯¼çš„æ¼æ´å¼•å…¥è¿½è¸ªå·¥å…· (Improved V-SZZ)

## æ¦‚è¿°

æœ¬å·¥å…·é‡‡ç”¨ **"LLM ä¸»å¯¼ï¼Œå·¥å…·è¾…åŠ©"** çš„æ¶æ„ï¼Œä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹åˆ†æ Git æäº¤å†å²ï¼Œè‡ªåŠ¨è¿½è¸ªæ¼æ´ä»£ç çš„é¦–æ¬¡å¼•å…¥ç‚¹ (Vulnerability Introducing Commit, VIC)ã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸ§  **LLM ä¸»å¯¼å†³ç­–** - å¤§æ¨¡å‹åˆ†ææ¯ä¸ªæäº¤ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæ¼æ´å¼•å…¥ç‚¹
- ğŸ” **åŒæ¨¡å‹éªŒè¯** - å°æ¨¡å‹éªŒè¯å¤§æ¨¡å‹çš„åˆ¤æ–­ï¼Œå‡å°‘è¯¯åˆ¤
- ğŸ“‚ **è¾¹ç•Œå¤„ç†** - è‡ªåŠ¨å¤„ç†æ–‡ä»¶è¿ç§»/é‡å‘½ååœºæ™¯
- ğŸ” **æ‰©å±•æœç´¢** - ä½¿ç”¨ `git log -S` åœ¨æ•´ä¸ªä»“åº“ä¸­æœç´¢ä»£ç å†å²

---

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒé…ç½®

```bash
# å®‰è£…ä¾èµ–
pip install gitpython requests

# è®¾ç½® API å¯†é’¥ (å¯é€‰ï¼Œä»£ç ä¸­å·²é…ç½®é»˜è®¤å€¼)
set OPENAI_API_KEY=your-api-key
set OPENAI_BASE_URL=https://yunwu.ai/v1
set LLM_MODEL=gpt-5.1-codex
set SMALL_LLM_MODEL=gpt-5-mini
```

### æ–¹å¼ä¸€ï¼šå‘½ä»¤è¡Œå·¥å…· (æ¨è)

```bash
cd ICSE2022ReplicationPackage

# åŸºæœ¬ç”¨æ³•
python run.py <ä»“åº“è·¯å¾„> <ä¿®å¤æäº¤> <æ–‡ä»¶è·¯å¾„> <æ¼æ´å…³é”®è¯>

# ç¤ºä¾‹ï¼šè¿½è¸ª CVE-2015-1830
python run.py C:\repos\activemq 729c4731574f activemq-fileserver/src/main/java/org/apache/activemq/util/FilenameGuardFilter.java "replace"
```

#### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `repo_path` | Git ä»“åº“è·¯å¾„ | `C:\repos\activemq` |
| `fix_commit` | ä¿®å¤æäº¤çš„ hash | `729c4731574f` |
| `file_path` | æ¼æ´æ–‡ä»¶è·¯å¾„ | `src/main/java/...` |
| `keyword` | æ¼æ´ä»£ç å…³é”®è¯ | `replace` |
| `--cve` | CVE ç¼–å· (å¯é€‰) | `--cve "CVE-2015-1830"` |
| `-o` | è¾“å‡º JSON æ–‡ä»¶ (å¯é€‰) | `-o result.json` |
| `--no-validate` | ç¦ç”¨å°æ¨¡å‹éªŒè¯ | `--no-validate` |
| `--max-depth` | æœ€å¤§è¿½è¸ªæ·±åº¦ | `--max-depth 30` |

### æ–¹å¼äºŒï¼šPython API

```python
import os
import sys

# æ·»åŠ è·¯å¾„
sys.path.insert(0, 'icse2021-szz-replication-package/tools/pyszz')

# é…ç½® API
os.environ['OPENAI_API_KEY'] = 'your-api-key'
os.environ['OPENAI_BASE_URL'] = 'https://yunwu.ai/v1'
os.environ['LLM_MODEL'] = 'gpt-5.1-codex'
os.environ['SMALL_LLM_MODEL'] = 'gpt-5-mini'

from szz.llm_driven_szz import LLMDrivenSZZ

# åˆ›å»ºå®ä¾‹
szz = LLMDrivenSZZ(
    repo_path='C:/repos/activemq',
    enable_validation=True  # å¯ç”¨åŒæ¨¡å‹éªŒè¯
)

# è¿½è¸ªæ¼æ´å¼•å…¥ç‚¹
result = szz.find_vulnerability_introduction(
    fix_commit_hash='729c4731574ffffaf58ebefdbaeb3bd19ed1c7b7',
    file_path='activemq-fileserver/src/main/java/org/apache/activemq/util/FilenameGuardFilter.java',
    vulnerable_line='String guarded = filename.replace(":", "_")',
    cve_info='CVE-2015-1830 (CWE-22)'
)

# è¾“å‡ºç»“æœ
print(f"æ¼æ´å¼•å…¥æäº¤: {result['introduction_commit']}")
print(f"LLM è°ƒç”¨æ¬¡æ•°: {result['llm_calls']}")
```

---

## è¾“å‡ºç»“æœè¯´æ˜

### æ§åˆ¶å°è¾“å‡º

```
============================================================
ğŸ” å¼€å§‹è¿½è¸ªæ¼æ´å¼•å…¥ç‚¹
   ä¿®å¤æäº¤: 729c4731574f
   æ–‡ä»¶: activemq-fileserver/.../FilenameGuardFilter.java
   æ¼æ´ä»£ç : String guarded = filename.replace(":", "_")...
============================================================

ğŸ“œ æ‰¾åˆ° 6 ä¸ªå†å²æäº¤

ğŸ¤– å¤§æ¨¡å‹å·²å¯ç”¨: gpt-5.1-codex
ğŸ” åˆ†ææäº¤ [1/6]: 9fd5cb7dfe0f
   ğŸ“ LLM åˆ¤æ–­:
      - æ¼æ´ç›¸å…³: True
      - æ˜¯å¼•å…¥ç‚¹: False
      - ç»§ç»­è¿½è¸ª: True
      - ç½®ä¿¡åº¦: 0.14

...

ğŸ” åˆ†ææäº¤ [6/6]: e6d20f3932b5
   ğŸ“ LLM åˆ¤æ–­:
      - æ¼æ´ç›¸å…³: True
      - æ˜¯å¼•å…¥ç‚¹: True âœ“
      - ç½®ä¿¡åº¦: 0.58
ğŸ” éªŒè¯æ¨¡å‹å·²å¯ç”¨: gpt-5-mini
   âœ… å°æ¨¡å‹éªŒè¯é€šè¿‡

ğŸ¯ æ‰¾åˆ°æ¼æ´å¼•å…¥ç‚¹: e6d20f3932b5
```

### JSON è¾“å‡ºæ ¼å¼

```json
{
  "introduction_commit": "e6d20f3932b556377218ac2e353a2cc99d26d1ea",
  "fix_commit": "729c4731574ffffaf58ebefdbaeb3bd19ed1c7b7",
  "file_path": "activemq-fileserver/.../FilenameGuardFilter.java",
  "vulnerable_line": "String guarded = filename.replace(\":\"...",
  "llm_calls": 6,
  "validation_calls": 1,
  "tracked_commits": [
    {
      "hash": "e6d20f3932b5",
      "message": "Applied patch from Aleksi Kallio...",
      "is_introduction": true,
      "confidence": 0.58
    }
  ]
}
```

---

## è¾¹ç•Œåœºæ™¯å¤„ç†

### æ–‡ä»¶è¿ç§»/é‡å‘½å

å½“è¿½è¸ªåˆ°æ–‡ä»¶å†å²çš„æœ€åä¸€ä¸ªæäº¤æ—¶ï¼š

1. **æ£€æµ‹è¿ç§»æäº¤** - è¯†åˆ« "Moved", "Refactoring", "Restructured" ç­‰å…³é”®è¯
2. **æ‰©å±•æœç´¢** - ä½¿ç”¨ `git log -S` åœ¨æ•´ä¸ªä»“åº“ä¸­æœç´¢ä»£ç ç‰‡æ®µ
3. **è¿”å›è¾¹ç•Œ** - å¦‚æœæ— æ³•æ‰¾åˆ°æ›´æ—©çš„å†å²ï¼Œè¿”å›æœ€åä¸€ä¸ªæäº¤ä½œä¸ºè¾¹ç•Œ VIC

```
ğŸ“ å·²åˆ°è¾¾æ–‡ä»¶å†å²çš„æœ€åä¸€ä¸ªæäº¤
   LLM è®¤ä¸ºè¿™ä¸æ˜¯çœŸæ­£çš„é¦–æ¬¡ç¼–å†™ï¼ˆå¯èƒ½æ˜¯è¿ç§»/å¯¼å…¥ï¼‰

ğŸ” å°è¯•åœ¨æ•´ä¸ªä»“åº“ä¸­æœç´¢ç›¸ä¼¼ä»£ç ...

ğŸ“Œ å°† 40a7d3b6ac35 ä½œä¸ºå¯è¿½è¸ªèŒƒå›´å†…çš„å¼•å…¥ç‚¹
   ï¼ˆè¿™æ˜¯æ–‡ä»¶å†å²ä¸­åŒ…å«æ¼æ´ä»£ç çš„æœ€æ—©æäº¤ï¼‰
```

---

## è¿è¡Œæµ‹è¯•

### å•ä¸ª CVE æµ‹è¯•

```bash
python -c "
from szz.llm_driven_szz import LLMDrivenSZZ
szz = LLMDrivenSZZ('C:/repos/activemq', enable_validation=True)
result = szz.find_vulnerability_introduction(
    fix_commit_hash='729c4731574f',
    file_path='activemq-fileserver/.../FilenameGuardFilter.java',
    vulnerable_line='replace',
    cve_info='CVE-2015-1830'
)
print('ç»“æœ:', result.get('introduction_commit'))
"
```

### å®Œæ•´æµ‹è¯•å¥—ä»¶

```bash
python test_activemq_full.py
```

é¢„æœŸè¾“å‡ºï¼š
```
======================================================================
ğŸ“Š æµ‹è¯•æ±‡æ€»
======================================================================
  å‡†ç¡®ç‡: 3/4 (75.0%)

  âœ… CVE-2015-1830: æœŸæœ› e6d20f3932..., æ‰¾åˆ° e6d20f3932
  âœ… CVE-2012-6092: æœŸæœ› 40a7d3b6ac..., æ‰¾åˆ° 40a7d3b6ac
  âœ… CVE-2013-1880: æœŸæœ› 40a7d3b6ac..., æ‰¾åˆ° 40a7d3b6ac
  âŒ CVE-2014-3576: æœŸæœ› 98cd515fff..., æ‰¾åˆ° ...
```

---

## æ–‡ä»¶ç»“æ„

```
ICSE2022ReplicationPackage/
â”œâ”€â”€ run.py                    # å‘½ä»¤è¡Œå·¥å…·å…¥å£
â”œâ”€â”€ llm_client.py             # LLM API å®¢æˆ·ç«¯
â”œâ”€â”€ test_activemq_full.py     # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ icse2021-szz-replication-package/
â”‚   â””â”€â”€ tools/pyszz/szz/
â”‚       â””â”€â”€ llm_driven_szz.py # æ ¸å¿ƒå®ç° â­
â””â”€â”€ repos/                    # Git ä»“åº“ç›®å½•
    â””â”€â”€ activemq/             # æµ‹è¯•ä»“åº“
```

---

## API é…ç½®

| ç¯å¢ƒå˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|----------|--------|------|
| `OPENAI_API_KEY` | (å†…ç½®) | API å¯†é’¥ |
| `OPENAI_BASE_URL` | `https://yunwu.ai/v1` | API åœ°å€ |
| `LLM_MODEL` | `gpt-5.1-codex` | å¤§æ¨¡å‹ (Responses API) |
| `SMALL_LLM_MODEL` | `gpt-5-mini` | å°æ¨¡å‹ (Chat API) |

---

## å¸¸è§é—®é¢˜

### Q: API è¿”å› 429 é”™è¯¯ï¼Ÿ
**A:** è§¦å‘äº†é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾… 1-2 åˆ†é’Ÿåé‡è¯•ã€‚

### Q: æ‰¾ä¸åˆ°æ­£ç¡®çš„ VICï¼Ÿ
**A:** 
1. å°è¯•ä½¿ç”¨æ›´ç²¾ç¡®çš„ `vulnerable_line`
2. å¢åŠ  `--max-depth` å‚æ•°
3. æ£€æŸ¥ä¿®å¤æäº¤æ˜¯å¦æ­£ç¡®

### Q: å¦‚ä½•ç¦ç”¨å°æ¨¡å‹éªŒè¯ï¼Ÿ
**A:** ä½¿ç”¨ `--no-validate` æˆ–è®¾ç½® `enable_validation=False`

---

## æŠ€æœ¯åŸç†

1. **è·å–æ–‡ä»¶å†å²** - ä½¿ç”¨ `git log --follow` è·å–æ–‡ä»¶çš„å®Œæ•´ä¿®æ”¹å†å²
2. **é€æäº¤åˆ†æ** - LLM åˆ†ææ¯ä¸ªæäº¤çš„ diffï¼Œåˆ¤æ–­æ˜¯å¦å¼•å…¥äº†æ¼æ´
3. **åŒæ¨¡å‹éªŒè¯** - å°æ¨¡å‹éªŒè¯å¤§æ¨¡å‹çš„åˆ¤æ–­ï¼Œé˜²æ­¢è¯¯åˆ¤
4. **è¾¹ç•Œå¤„ç†** - æ£€æµ‹è¿ç§»æäº¤ï¼Œä½¿ç”¨æ‰©å±•æœç´¢æ‰¾åˆ°çœŸæ­£çš„å¼•å…¥ç‚¹

---

## ç‰ˆæœ¬ä¿¡æ¯

- **ç‰ˆæœ¬**: 2.0 (LLM-Driven)
- **æ—¥æœŸ**: 2026-01-15
- **ä½œè€…**: Improved V-SZZ Team
